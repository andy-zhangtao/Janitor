# Janitor: macOS 开发环境智能清理工具

## 项目背景

### 问题描述

现代软件开发中，开发者经常需要使用多种编程语言和依赖管理工具。随着时间推移，这些工具会在本地系统中积累大量缓存文件和依赖包，导致以下问题：

1. **磁盘空间浪费**：依赖缓存只增不减，占用大量存储空间
2. **项目迁移困难**：删除项目后，相关依赖缓存仍然残留
3. **版本冲突混乱**：同一依赖的多个版本同时存在
4. **清理风险高**：手动清理可能误删正在使用的依赖

### 核心痛点

以 Go 语言为例，`go mod tidy` 命令只负责维护项目的 `go.mod` 文件，但从不清理全局模块缓存 (`$GOPATH/pkg/mod`)。即使项目被删除或依赖发生变化，旧的模块版本仍会永久占用磁盘空间。对于维护多个项目的开发者，这种积累效应尤为明显。

类似问题也存在于其他语言生态：
- **Node.js**: npm 缓存和 `node_modules` 目录
- **Python**: pip 缓存和虚拟环境
- **Rust**: Cargo 缓存和构建产物

### 解决方案

Janitor 是一款专为 macOS 开发者设计的智能依赖清理工具，通过智能分析和安全清理，帮助开发者：
- 回收磁盘空间
- 保持开发环境整洁
- 避免误删风险
- 支持多语言生态

## 实现逻辑

### 核心算法

#### 1. 项目发现算法
扫描文件系统，根据不同语言的项目标识文件（如 go.mod、package.json）来识别活跃的开发项目。

#### 2. 依赖解析算法
针对不同语言使用相应的工具和方法解析项目依赖关系：
- Go: 调用 `go list -m all` 获取完整依赖树
- Node.js: 解析 package.json 和 package-lock.json
- Python: 分析 requirements.txt 和虚拟环境
- Rust: 解析 Cargo.toml 文件

#### 3. 清理检测算法
通过对比活跃项目的依赖需求和系统缓存中的实际文件，识别出不再被任何项目使用的孤立依赖。

### 安全策略

1. **保守清理原则**：宁可保留也不误删
2. **用户确认机制**：清理前显示详细预览
3. **操作记录**：记录清理操作，便于问题排查
4. **权限检查**：确保有足够权限访问系统目录

### 技术实现细节

#### Go 语言依赖分析
- 扫描文件系统寻找包含 `go.mod` 的目录
- 在每个项目目录执行 `go list -m all` 获取完整依赖树
- 解析 `$GOPATH/pkg/mod` 目录结构，映射缓存文件
- 交叉验证项目依赖和缓存文件，识别孤立依赖

#### 文件系统操作
- 递归扫描指定目录寻找项目
- 解析目录命名规则提取模块信息
- 计算文件大小统计潜在清理收益
- 安全删除操作，避免误删系统文件

## 预期效果

### 用户体验目标

1. **操作简单**：一键扫描，智能分析，安全清理
2. **结果可视**：清晰展示依赖关系和清理预览
3. **过程透明**：详细的操作日志和进度指示
4. **风险可控**：多重确认机制，支持操作回滚

### 功能效果预期

1. **空间回收**：平均为开发者回收 1-10GB 磁盘空间
2. **性能提升**：减少依赖扫描时间，提升构建效率
3. **环境整洁**：保持开发环境的最小必要依赖集合
4. **多语言支持**：成为开发者工具箱的必备清理工具

### 成功指标

- **准确性**：0% 误删率，100% 安全清理
- **覆盖率**：支持主流编程语言和包管理器
- **用户满意度**：简单易用，功能完备
- **生态集成**：与 macOS 系统深度集成

## Roadmap

### Phase 1: MVP (Go 语言支持)
- [ ] Go 项目自动发现（扫描文件系统中的 go.mod 文件）
- [ ] Go 模块缓存分析（解析 `$GOPATH/pkg/mod` 目录结构）
- [ ] 依赖关系解析（调用 `go list -m all` 获取项目依赖）
- [ ] 孤立依赖检测（识别未被任何项目使用的缓存模块）
- [ ] 基础 SwiftUI 界面（项目列表、依赖展示、清理预览）
- [ ] 安全清理操作（用户确认后执行删除）
- [ ] 存储空间统计（显示可清理的磁盘空间）
- [ ] 基础错误处理和日志记录

### Phase 2: 用户体验增强
- [ ] 完整的 macOS 原生界面设计
- [ ] 详细的依赖关系可视化（树状结构展示）
- [ ] 干净运行模式（预览清理结果，不实际删除）
- [ ] 扫描进度指示器（实时显示扫描状态）
- [ ] 清理历史记录（记录每次清理的详细信息）
- [ ] 用户配置管理（忽略特定项目或依赖）
- [ ] macOS 权限请求处理（全磁盘访问权限）
- [ ] 系统通知集成（扫描和清理完成提醒）

### Phase 3: 智能分析功能
- [ ] 项目活跃度分析（基于文件修改时间）
- [ ] 智能清理建议（推荐清理策略）
- [ ] 版本冲突检测（同一依赖的多版本分析）
- [ ] 依赖使用频率统计
- [ ] 批量项目管理（工作区概念）
- [ ] 清理规则自定义（基于时间、大小、使用频率）
- [ ] 导出分析报告（PDF/CSV 格式）

### Phase 4: Node.js 支持
- [ ] Node.js 项目发现（package.json 文件）
- [ ] npm/yarn 缓存分析
- [ ] node_modules 目录分析
- [ ] 重复依赖检测（跨项目的相同依赖）
- [ ] package-lock.json 解析
- [ ] npm 全局包管理
- [ ] yarn berry/pnp 支持

### Phase 5: Python 支持
- [ ] Python 项目发现（requirements.txt、pyproject.toml）
- [ ] pip 缓存清理
- [ ] 虚拟环境检测和管理
- [ ] conda 环境支持
- [ ] 未使用包检测（基于 import 分析）
- [ ] Poetry/Pipenv 项目支持
- [ ] 全局 Python 包管理

### Phase 6: Rust 支持
- [ ] Cargo 项目发现（Cargo.toml 文件）
- [ ] Cargo 缓存分析（target 目录、registry 缓存）
- [ ] 依赖版本解析
- [ ] 构建产物清理
- [ ] Cargo workspace 支持
- [ ] 交叉编译缓存管理

### Phase 7: 高级系统清理
- [ ] Docker 镜像和容器清理
- [ ] IDE 缓存清理（Xcode、VSCode、IntelliJ）
- [ ] 系统开发相关缓存（Homebrew、CocoaPods）
- [ ] Git 仓库清理（.git 目录优化）
- [ ] 临时文件和日志清理
- [ ] 编译缓存统一管理

### Phase 8: 自动化和集成
- [ ] 定期自动扫描（后台服务）
- [ ] Finder 右键菜单集成
- [ ] 命令行工具（CLI 接口）
- [ ] AppleScript 支持
- [ ] Shortcuts 应用集成
- [ ] 系统启动时自动检查

### Phase 9: 企业和协作功能
- [ ] 团队配置同步（iCloud/Git）
- [ ] 清理策略模板
- [ ] 详细使用报告和统计
- [ ] 多用户环境支持
- [ ] 企业策略管理
- [ ] 审计日志功能

### Phase 10: 生态系统扩展
- [ ] 插件系统架构
- [ ] 第三方语言支持框架
- [ ] 社区贡献的清理规则
- [ ] 云存储项目扫描
- [ ] 远程开发环境支持
- [ ] AI 驱动的智能建议

## 技术选型

### 核心技术栈

#### 应用框架
- **SwiftUI + AppKit**：现代化的 macOS 原生开发
  - SwiftUI 用于界面构建，获得最新的 macOS 设计语言支持
  - AppKit 用于需要更底层系统集成的功能
  - 完美的 macOS 系统集成和性能

#### 后端逻辑
- **Swift**：统一的开发语言
  - 原生 Foundation 框架处理文件系统操作
  - Process 类调用系统命令（如 `go list -m all`）
  - FileManager 用于目录扫描和文件操作
  - 无需维护多语言代码库

#### 数据存储
- **Core Data**：依赖关系和扫描历史存储
- **UserDefaults**：用户配置和偏好设置
- **SQLite**：复杂的依赖分析数据（如果 Core Data 不够用）

#### 系统集成
- **Security Framework**：请求系统权限（全磁盘访问等）
- **ServiceManagement**：可选的后台服务功能
- **Combine**：响应式编程，处理异步扫描操作
- **OSLog**：系统级日志记录

### 开发工具和流程

#### 开发环境
- **Xcode 15+**：原生开发环境
- **Swift 5.9+**：最新语言特性
- **macOS 13.0+**：目标系统版本

#### 构建和分发
- **Xcode Build System**：原生构建
- **Developer ID 签名**：应用公证
- **Mac App Store** 或 **直接分发**
- **Sparkle Framework**：自动更新（如果不上架 App Store）

#### 测试
- **XCTest**：单元测试和集成测试
- **UI Tests**：界面自动化测试
- **Instruments**：性能分析

### macOS 特有优势

#### 系统集成
- **Finder 扩展**：右键菜单快速扫描项目
- **Spotlight 插件**：搜索依赖信息
- **Touch Bar 支持**：快捷操作按钮
- **Notification Center**：扫描完成通知

#### 用户体验
- **原生外观**：完美适配 macOS 设计语言
- **黑暗模式**：自动适配系统主题
- **多窗口支持**：同时处理多个项目
- **键盘快捷键**：提升效率

#### 性能优化
- **Metal 加速**：大量数据的可视化展示
- **Grand Central Dispatch**：多线程文件扫描
- **Memory Mapping**：高效处理大文件

---

**项目目标**：让开发环境像代码一样整洁，成为 macOS 开发者必备的系统维护工具。
